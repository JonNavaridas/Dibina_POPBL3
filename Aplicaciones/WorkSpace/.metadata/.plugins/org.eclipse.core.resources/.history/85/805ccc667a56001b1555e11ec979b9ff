package comunicacionServer;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.EOFException;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.Queue;
import java.util.stream.Collectors;

import elementos.Pedido;
import elementos.User;

public class GestorElementos extends Thread {

	private static final String FICHERO_LOG = "Files/log.txt";
	private static final String FICHERO_USUARIOS = "Files/users.csv";
	private static final String FICHERO_PEDIDOS = "Files/pedidos.dat";
	private static final String FICHERO_PRODUCTOS = "Files/productos.dat";
	public static final String FICHERO_CREAR_USUARIOS = "Files/CreateUsers.csv";

	Queue<ElementoEnCola> listaDeEspera;
	private boolean running;
	
	public GestorElementos() {
		listaDeEspera = new LinkedList<>();
		running = false;
	}
	
	public void addElementoACola(int operacion, String line) {
		listaDeEspera.add(new ElementoEnCola(operacion, line));
		if (!running) {
			running = true;
			this.start();
		}
	}
	
	private void realizarAccion() throws ParseException, IOException {
		ElementoEnCola elemento = listaDeEspera.remove();
		
		switch(elemento.getOperacion()) {
		case 1: addPedido(elemento.transformToPedido());
			break;
		case 2: removePedido(elemento.transformToPedido());
			break;
		case 3: añadirUsuario(elemento.transformToUser());
			break;
		case 4: cambiarContraseña(elemento.transformToUser(), -1);
			break;
		default:
			System.out.println("Operacion no disponible"); 
			return;
		}
		if (listaDeEspera.size() == 0) running = false;
		writeLog(elemento);
	}

	@Override
	public void run() {
		do {
			try {
				realizarAccion();
			} catch (ParseException e) {
				e.printStackTrace();
			} catch (IOException e) {
				e.printStackTrace();
			}
		} while (running);
	}
	
	@SuppressWarnings("unchecked")
	private void addPedido(Pedido p) {
		List<Pedido> listaPedidos = null;
		
		try(ObjectInputStream in  = new ObjectInputStream(new FileInputStream(FICHERO_PEDIDOS))) {
			listaPedidos = (List<Pedido>) in.readObject();
			if (listaPedidos == null) listaPedidos = new ArrayList<>();
			
			ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(FICHERO_PEDIDOS));
			listaPedidos.add(p);
			
			out.writeObject(listaPedidos);
			out.close();
			
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		}catch (EOFException e){
			
		}catch (IOException e) {
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}
	}
	
	@SuppressWarnings("unchecked")
	private void removePedido(Pedido p) {
		List<Pedido> listaPedidos = null;
		
		try(ObjectInputStream in  = new ObjectInputStream(new FileInputStream(FICHERO_PEDIDOS))) {
			listaPedidos = (List<Pedido>) in.readObject();
			if (listaPedidos != null) {
				ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(FICHERO_PEDIDOS));
				listaPedidos.remove(p);
				
				out.writeObject(listaPedidos);
				out.close();
			}
			
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		}catch (EOFException e){
			
		}catch (IOException e) {
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}
	}
	
	public void añadirUsuario(User user) throws IOException {
		BufferedWriter out = new BufferedWriter(new FileWriter(FICHERO_USUARIOS, true));
		
		String output = user.getID() + "," + user.getName() + "," + user.getFullName() + "," +
						user.getContraseña() + "," + user.getPermisos().getInicial();
		out.write(output + "\n");
		out.close();
		
		File file = new File(FICHERO_CREAR_USUARIOS);
		boolean ficheroVacio = !file.exists();
		out = new BufferedWriter(new FileWriter(file, true));
		
		if (ficheroVacio) out.write("GivenName,Surname,Name,DisplayName,SamAccountName\n");
		out.write(user.createUserString() + "\n");
		out.close();
	}
	
	private void cambiarContraseña(User user, int newPassword) throws IOException { // Cambia la contraseña del usuario asignado.
        String oldLine = user.getID() + "," + user.getName() + "," + user.getContraseña();
        String newLine = user.getID() + "," + user.getName() + "," + newPassword;
        
        List<String> usuarios = new ArrayList<>();
        BufferedReader in = new BufferedReader(new FileReader(FICHERO_USUARIOS));
		
        System.out.println(newLine);
        
		String linea;
		while ((linea = in.readLine()) != null) usuarios.add(linea);
		in.close();
		
		usuarios.remove(oldLine);
		usuarios.add(newLine);
		
		usuarios = usuarios.stream().sorted().collect(Collectors.toList());
		
		BufferedWriter out = new BufferedWriter(new FileWriter(FICHERO_USUARIOS));
		usuarios.stream().forEach((a)->{
			try {
				out.write(a + "\n");
			} catch (IOException e) {
				e.printStackTrace();
			}
		});
		out.close();
	}
	
	private void writeLog(ElementoEnCola elemento) {
		String tipo = "";
		
		try {
			BufferedWriter out = new BufferedWriter(new FileWriter(FICHERO_LOG));
			try {
				switch(elemento.getOperacion()) {
				case 1:
				case 2:
					out.write(elemento.getOperacion() + ": Pedido " + elemento.getElemento().split("#")[0] + "\n");
					break;
				case 3:
				case 4:
					out.write(elemento.getElemento() + ": User " + elemento.getElemento().split("$")[0]);
					break;
				default:
					tipo = "error";
					break;
				}
			} 
			catch (IOException e) {
				e.printStackTrace();
			}
			out.close();
		} 
		catch (IOException e) {
			e.printStackTrace();
		}
	}
}
